<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proyecto Musical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let chart;
    let timeData = [];
    let frequencyData = [];

    async function actualizarDatos() {
      const response = await fetch("/datos");
      const datos = await response.json();

      const tabla = document
        .getElementById("datos-tabla")
        .getElementsByTagName("tbody")[0];
      tabla.innerHTML = "";

      datos.forEach((dato) => {
        const row = tabla.insertRow();
        row.insertCell(0).innerText = dato.tecla;
        row.insertCell(1).innerText = dato.nota_tecla; // Mostrar el nuevo campo
        row.insertCell(2).innerText = dato.frecuencia;
        row.insertCell(3).innerText = dato.nota;
        row.insertCell(4).innerText = dato.correcta ? "Sí" : "No";
        row.insertCell(5).innerText = dato.timestamp;
        // Actualizar datos para la gráfica
        const timestamp = dato.timestamp;
        if (timeData.length === 10) {
          timeData.shift();
          frequencyData.shift();
        }
        timeData.push(timestamp);
        frequencyData.push(dato.frecuencia);
      });

      chart.data.labels = timeData;
      chart.data.datasets[0].data = frequencyData;
      chart.update("none"); // 'none' desactiva las animaciones
    }

    async function actualizarEstadisticas() {
      const response = await fetch("/estadisticas");
      const estadisticas = await response.json();

      document.getElementById("total-notas").innerText =
        estadisticas.total_notas;
      document.getElementById("total-correctas").innerText =
        estadisticas.total_correctas;
      document.getElementById("porcentaje-correctas").innerText =
        estadisticas.porcentaje_correctas.toFixed(2) + "%";
    }

    async function actualizarEstadisticasPorNota() {
      const response = await fetch("/notas");
      const estadisticas = await response.json();

      const tablaEfectividad = document
        .getElementById("efectividad-tabla")
        .getElementsByTagName("tbody")[0];
      tablaEfectividad.innerHTML = "";



      //Estructura de mis json
      // {
      //     "nota": "B4",
      //     "porcentaje_correctas": 100,
      //     "total_correctas": 13,
      //     "total_notas": 13
      // }

      // Ordenar el array según el orden musical
      const ordenMusical = ["C", "D", "E", "F", "G", "A", "B"];
      const ordenarPorNota = (a, b) => {
        const octavaA = parseInt(a.nota.slice(-1));
        const octavaB = parseInt(b.nota.slice(-1));
        const notaA = a.nota.slice(0, -1);
        const notaB = b.nota.slice(0, -1);

        const indexA = ordenMusical.indexOf(notaA);
        const indexB = ordenMusical.indexOf(notaB);

        if (indexA === indexB) {
          return octavaA - octavaB;
        } else {
          return indexA - indexB;
        }
      };

      estadisticas.sort(ordenarPorNota);

      estadisticas.forEach((estadistica) => {
        const row = tablaEfectividad.insertRow();
        row.insertCell(0).innerText = estadistica.nota;
        row.insertCell(1).innerText = estadistica.total_notas;
        row.insertCell(2).innerText = estadistica.total_correctas;
        row.insertCell(3).innerText =
          estadistica.porcentaje_correctas.toFixed(2) + "%";
      });


    }

    function crearGrafica() {
      const ctx = document.getElementById("frecuenciaChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: timeData,
          datasets: [
            {
              label: "Frecuencia vs Tiempo",
              data: frequencyData,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              fill: false,
            },
          ],
        },
        options: {
          animation: {
            duration: 0, // Desactivar animaciones
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Tiempo",
              },
            },
            y: {
              title: {
                display: true,
                text: "Frecuencia (Hz)",
              },
            },
          },
        },
      });
    }

    window.onload = function () {
      crearGrafica();
      actualizarDatos();
      actualizarEstadisticasPorNota();
      actualizarEstadisticas();
      setInterval(() => {
        actualizarDatos();
        actualizarEstadisticasPorNota();
        actualizarEstadisticas();
      }, 1000);
    };
  </script>
</head>

<body>
  <div class="container mx-auto p-4">
    <div class="grid items-center gap-4 mb-4">
      <div class="border border-gray-500 p-10 pt-0 rounded-3xl h-full w-full>
          <h1 class=" text-2xl font-bold mt-5">Datos en Tiempo Real</h1>
        <table id="datos-tabla" class="table-auto w-full mt-3 border-collapse border border-gray-200">
          <thead class="bg-gray-200">
            <tr>
              <th class="border border-gray-300 px-4 py-2">Tecla</th>
              <th class="border border-gray-300 px-4 py-2">Nota Tecla</th>
              <!-- Nueva columna -->
              <th class="border border-gray-300 px-4 py-2">Frecuencia</th>
              <th class="border border-gray-300 px-4 py-2">Nota Detectada</th>
              <th class="border border-gray-300 px-4 py-2">Correcta</th>
              <th class="border border-gray-300 px-4 py-2">Timestamp</th>
            </tr>
          </thead>
          <tbody>
            <!-- Los datos se cargarán aquí -->
          </tbody>
        </table>
      </div>
      <div>

        <h2 class="text-xl font-semibold mt-5">
          Gráfica de Frecuencia vs Tiempo
        </h2>
        <canvas id="frecuenciaChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div class="flex items-center gap-4 mb-4">
      <div class="border border-gray-500 p-10 pt-0 rounded-3xl h-full w-full>
                <h2 class=" text-xl font-bold mt-10">Efectividad por Nota</h2>
        <table id="efectividad-tabla" class="table-auto w-full mt-3 border-collapse border border-gray-200">
          <thead class="bg-gray-200">
            <tr>
              <th class="border border-gray-300 px-4 py-2">Nota</th>
              <th class="border border-gray-300 px-4 py-2">Total</th>
              <th class="border border-gray-300 px-4 py-2">Correctas</th>
              <th class="border border-gray-300 px-4 py-2">Efectividad</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h2 class="text-xl font-semibold mt-5">Estadísticas</h2>
        <ul class="list-group mt-3">
          <li class="list-group-item flex justify-between items-center">
            Total de notas
            <span id="total-notas" class="badge bg-blue-500 text-white rounded-full px-2 py-1">0</span>
          </li>
          <li class="list-group-item flex justify-between items-center">
            Total de notas correctas
            <span id="total-correctas" class="badge bg-green-500 text-white rounded-full px-2 py-1">0</span>
          </li>
          <li class="list-group-item flex justify-between items-center">
            Porcentaje de notas correctas
            <span id="porcentaje-correctas" class="badge bg-teal-500 text-white rounded-full px-2 py-1">0%</span>
          </li>
        </ul>
      </div>

    </div>

  </div>
</body>

</html>